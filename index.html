<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Churn Dashboard - Advanced Filters</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        .reason-chip { @apply px-2 py-1 rounded text-xs font-medium mr-1 mb-1 inline-block; }
        .filter-checkbox { @apply w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500; }
        input[type=number] { @apply w-20 px-2 py-1 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-blue-500; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">

    <div class="max-w-6xl mx-auto px-4 py-10">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-end mb-10 gap-4 border-b pb-8">
            <div>
                <h1 class="text-4xl font-extrabold text-slate-800 tracking-tight">Churn Feedback Tool</h1>
                <p class="text-slate-500 mt-2 text-lg">Filter op lengte van de feedback voor diepere inzichten.</p>
            </div>
            
            <div class="flex items-center gap-3">
                <label class="flex flex-col items-center px-4 py-2 bg-white text-blue-600 rounded-xl shadow-sm border border-blue-200 cursor-pointer hover:bg-blue-50 transition-all">
                    <span class="text-sm font-semibold">üìÅ Upload CSV</span>
                    <input type='file' id="csv-file" class="hidden" accept=".csv" />
                </label>
                <div id="status-badge" class="hidden bg-blue-600 text-white px-4 py-2 rounded-full font-bold text-sm shadow-md">
                    <span id="record-count">0</span> records
                </div>
            </div>
        </header>

        <div id="controls" class="hidden space-y-6 mb-8">
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase mb-1 block ml-1">Zoeken</label>
                    <input type="text" id="search" placeholder="E-mail of trefwoord..." 
                           class="w-full pl-4 pr-4 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                </div>

                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase mb-1 block ml-1">Hoofdreden</label>
                    <select id="filter-reason" class="w-full p-2 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Alle hoofdredenen</option>
                        <option value="Ik rij te weinig">Ik rij te weinig</option>
                        <option value="permissies">Permissies</option>
                        <option value="crasht">Crasht / doet het niet</option>
                        <option value="navigatie">Navigatie</option>
                        <option value="Anders">Anders</option>
                    </select>
                </div>

                <div>
                    <label class="text-xs font-bold text-red-400 uppercase mb-1 block ml-1">Sluit woorden uit</label>
                    <input type="text" id="exclude-input" placeholder="bv: ander account" 
                           class="w-full pl-4 pr-4 py-2 border border-red-100 rounded-xl focus:ring-2 focus:ring-red-400 outline-none bg-red-50/30">
                </div>
            </div>

            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 flex flex-wrap items-center gap-8 px-6">
                <div class="flex gap-6 border-r pr-8 border-slate-200">
                    <label class="flex items-center gap-2 cursor-pointer group">
                        <input type="checkbox" id="check-email" class="filter-checkbox">
                        <span class="text-sm font-medium text-slate-700 group-hover:text-blue-600">Met e-mail</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer group">
                        <input type="checkbox" id="check-open" class="filter-checkbox">
                        <span class="text-sm font-medium text-slate-700 group-hover:text-blue-600">Met toelichting</span>
                    </label>
                </div>

                <div class="flex items-center gap-4">
                    <span class="text-xs font-bold text-slate-400 uppercase">Feedback lengte (tekens):</span>
                    <div class="flex items-center gap-2">
                        <label class="text-xs text-slate-500 italic">Van</label>
                        <input type="number" id="min-chars" value="0" min="0">
                        <label class="text-xs text-slate-500 italic">Tot</label>
                        <input type="number" id="max-chars" placeholder="‚àû">
                    </div>
                </div>
            </div>
        </div>

        <div id="table-container" class="hidden bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-800 text-white text-sm uppercase tracking-wider">
                            <th class="px-6 py-4 font-semibold whitespace-nowrap">Datum</th>
                            <th class="px-6 py-4 font-semibold">E-mail</th>
                            <th class="px-6 py-4 font-semibold">Geselecteerde Reden</th>
                            <th class="px-6 py-4 font-semibold">Open Feedback</th>
                            <th class="px-6 py-4 font-semibold text-center w-20">Lengte</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>

        <div id="placeholder" class="py-20 text-center border-2 border-dashed border-slate-200 rounded-2xl">
            <p class="text-slate-400 text-lg">Upload je CSV bestand om de karakterfilters te gebruiken.</p>
        </div>
    </div>

    <script>
        let fullData = [];
        const reasonCols = [
            'De app doet het niet (crasht)', 
            'Ik rij te weinig', 
            'Ik krijg te veel informatie, of snap niet wat de app voor mij doet', 
            'Te veel gedoe met permissies', 
            'De navigatie is niet goed genoeg', 
            'Anders, namelijk'
        ];

        document.getElementById('csv-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    processData(results.data);
                }
            });
        });

        function processData(data) {
            fullData = data.filter(row => row['Response Type'] === 'completed').map(row => {
                const selectedReasons = reasonCols.filter(col => row[col] && row[col].trim() !== "");
                const openText = (row['We horen graag welke reden je hebt om de app niet meer te gebruiken'] || '').trim();
                return {
                    date: (row['Submit Date (UTC)'] || '').split(' ')[0],
                    email: (row['Mogen we je in de toekomst benaderen voor meer informatie? '] || '').trim(),
                    reasons: selectedReasons.join(', '),
                    open: openText,
                    length: openText.length
                };
            });

            document.getElementById('controls').classList.remove('hidden');
            document.getElementById('table-container').classList.remove('hidden');
            document.getElementById('status-badge').classList.remove('hidden');
            document.getElementById('placeholder').classList.add('hidden');
            
            handleFilter();
        }

        function render(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 transition-colors";
                
                const emailHtml = item.email 
                    ? `<span class="text-blue-600 font-medium">${item.email}</span>` 
                    : `<span class="text-slate-300 italic text-xs">Geen email</span>`;

                tr.innerHTML = `
                    <td class="px-6 py-5 text-xs text-slate-400 font-mono">${item.date}</td>
                    <td class="px-6 py-5 text-sm">${emailHtml}</td>
                    <td class="px-6 py-5 text-sm font-semibold text-slate-600">${item.reasons || '-'}</td>
                    <td class="px-6 py-5 text-sm text-slate-700 leading-relaxed">${item.open || '-'}</td>
                    <td class="px-6 py-5 text-xs text-center font-bold ${item.length > 50 ? 'text-green-500' : 'text-slate-300'}">${item.length}</td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('record-count').innerText = data.length;
        }

        function handleFilter() {
            const query = document.getElementById('search').value.toLowerCase();
            const category = document.getElementById('filter-reason').value.toLowerCase();
            const excludeVal = document.getElementById('exclude-input').value.toLowerCase();
            const excludeTerms = excludeVal.split(',').map(t => t.trim()).filter(t => t !== "");

            const onlyWithEmail = document.getElementById('check-email').checked;
            const onlyWithOpen = document.getElementById('check-open').checked;

            // Karakter filters
            const minChars = parseInt(document.getElementById('min-chars').value) || 0;
            const maxCharsVal = document.getElementById('max-chars').value;
            const maxChars = maxCharsVal === "" ? Infinity : parseInt(maxCharsVal);

            const filtered = fullData.filter(item => {
                const openText = item.open.toLowerCase();
                
                // 1. Lengte check
                if (item.length < minChars || item.length > maxChars) return false;

                // 2. Email & Open check
                if (onlyWithEmail && item.email === "") return false;
                if (onlyWithOpen && item.open === "") return false;

                // 3. Uitsluiten
                const hasExcludedTerm = excludeTerms.some(term => openText.includes(term));
                if (hasExcludedTerm) return false;

                // 4. Zoeken & Categorie
                const matchesSearch = item.email.toLowerCase().includes(query) || openText.includes(query);
                const matchesCategory = item.reasons.toLowerCase().includes(category);

                return matchesSearch && matchesCategory;
            });
            render(filtered);
        }

        // Event Listeners
        const inputs = ['search', 'filter-reason', 'exclude-input', 'check-email', 'check-open', 'min-chars', 'max-chars'];
        inputs.forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener(el.type === 'checkbox' ? 'change' : 'input', handleFilter);
        });
    </script>
</body>
</html>